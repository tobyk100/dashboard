-# Common scripts and styles
- blockly_path = "/blockly/dist/"
= stylesheet_link_tag blockly_path + "common.css"
= stylesheet_link_tag blockly_path + "#{app}/style.css"

= stylesheet_link_tag "//cdnjs.cloudflare.com/ajax/libs/qtip2/2.1.0/jquery.qtip.min.css"
= javascript_include_tag "//cdnjs.cloudflare.com/ajax/libs/qtip2/2.1.0/jquery.qtip.min.js"
= javascript_include_tag blockly_path + "_soy/soyutils.js"
= javascript_include_tag blockly_path + "#{app}/generated/en_us.js"

= javascript_include_tag blockly_path + "blockly_compressed.js"
= javascript_include_tag blockly_path + "blocks_compressed.js"
= javascript_include_tag blockly_path + "javascript_compressed.js"
= javascript_include_tag blockly_path + "en.js"

= javascript_include_tag blockly_path + "#{app}/#{app}.js"
:javascript
  var CALLOUTS = JSON.parse('#{escape_javascript @callouts.to_json}');
  var nextRedirect;
  var sendReport = function(report) {
    var httpRequest = new XMLHttpRequest();
    httpRequest.onload = function() {
      var response = JSON.parse(httpRequest.responseText);
      nextRedirect = response['redirect'];
    };
    httpRequest.open('POST', '#{@callback}');
    httpRequest.setRequestHeader('Content-Type',
        'application/x-www-form-urlencoded');
    var query = [];
    for (var key in report) {
      query.push(key + '=' + report[key]);
    }
    query = query.join('&');
    httpRequest.send(query);
  };
  var callout = function() {
    var sessionPrefix = "callout_";

    for (var index in CALLOUTS) {
      var callout = CALLOUTS[index];
      var selector = callout.element_id;  // jquery selector.
      if (!(sessionPrefix + selector in sessionStorage)) {  // show only once.
        var calloutDomElement = $(selector).qtip({
          content: {
            text: callout.text
          }
        });
        calloutDomElement.qtip('show');
        if (calloutDomElement.length > 0) {  // Only store if callout was shown.
          sessionStorage.setItem(sessionPrefix + selector, true);
        }
      }
    }
  };
  #{app}Main({
    onAttempt: function(report) {
      sendReport(report);
    },
    onContinue: function() {
      if (nextRedirect) {
        window.location.href = nextRedirect;
      }
    },
    onInitialize: function() {
      callout();
    },
    level: {
      instructions: '#{escape_javascript @level.instructions}'
    },
  });
